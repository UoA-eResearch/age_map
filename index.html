<html>
  <head>
    <title>2018 Census age data in NZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js" integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <h1 id="title">2018 Census age data in NZ</h1>
    <div id="map"></div>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      var colour_mode = "pct";
      var MAX_DOMAIN = 20;
      if (urlParams.get("colour_by") == "raw_counts") {
        colour_mode = "raw_counts";
        MAX_DOMAIN = 500;
      }

      var map = L.map('map', {
        zoom: 6,
        minZoom: 6,
        maxZoom: 14,
        center: [-41.235726,172.5118422]
      });
      var bounds = map.getBounds();
      bounds._northEast.lat += 10;
      bounds._northEast.lng += 10;
      bounds._southWest.lat -= 10;
      bounds._southWest.lng -= 10;
      map.setMaxBounds(bounds);

      var baseMaps = {
        "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
        "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
        "CartoDB Positron": L.tileLayer.provider('CartoDB.PositronNoLabels').addTo(map),
        "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
        "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
        "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }),
        "Wikimedia": L.tileLayer.provider("Wikimedia")
      }
      
      var ageLayer = L.layerGroup().addTo(map);
      var DHBLayer = L.layerGroup();
      var hospitalLayer = L.markerClusterGroup({
        maxClusterRadius: 40,
      }).addTo(map);

      map.createPane('labels');
      map.getPane('labels').style.zIndex = 625;
      map.getPane('labels').style.pointerEvents = 'none';
      var labels = L.tileLayer.provider("Stamen.TonerLabels", {
          pane: "labels",
          interactive: false,
          opacity: .8,
      });

      map.createPane('whitelabels');
      map.getPane('whitelabels').style.zIndex = 625;
      map.getPane('whitelabels').style.pointerEvents = 'none';
      map.getPane('whitelabels').style.filter = 'invert(100%)';
      var whitelabels = L.tileLayer.provider("Stamen.TonerLabels", {
          pane: "whitelabels",
          interactive: false,
          opacity: .8,
      });

      var overlays = {
          "Age data": ageLayer,
          "Hospitals": hospitalLayer,
          "DHBs": DHBLayer,
          "City labels": labels,
          "City labels (white)": whitelabels,
      }

      L.control.layers(baseMaps, overlays).addTo(map);

      var cmap = chroma.scale("Blues").domain([0, MAX_DOMAIN]);

      function popupHandler(e) {
        console.log(e);
        var px = map.project(e.target._popup._latlng);
        px.y -= e.target._popup._container.clientHeight * 3;
        map.panTo(map.unproject(px),{animate: true});
        var data = e.popup.options.data;
        console.log(data);
        var keys = ["0-4 years", "5-9 years", "10-14 years", "15-19 years", "20-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years", "60-64 years", "65-69 years", "70-74 years", "75-79 years", "80-84 years", "85 years and over"];
        var maleValues = [];
        var malePcts = [];
        var femaleValues = [];
        var femalePcts = [];
        for (var i in keys) {
          var k = keys[i]
          maleValues.push(data.Male[k]);
          femaleValues.push(data.Female[k]);
          malePcts.push(Math.round(data.Male[k] / data.Male.Total * 100 * 100) / 100 + "%");
          femalePcts.push(Math.round(data.Female[k] / data.Female.Total * 100 * 100) / 100 + "%");
        }
        var plotData = [
          {
            x: keys,
            y: maleValues,
            name: "Male",
            text: malePcts,
            type: 'bar',
          },
          {
            x: keys,
            y: femaleValues,
            name: "Female",
            text: femalePcts,
            type: "bar"
          }
        ];
        var layout = {
            title: "Gender and age distribution of " + data.name + ". Total people stated: " + data.Total.Total,
            barmode: 'stack',
            xaxis: {
                title: "Age Bracket"
            },
            yaxis: {
                title: "Number of people",
            },
        }

        var container = $("#graph", e.popup._contentNode);
        Plotly.newPlot(container[0], plotData, layout);
      }
      
      $.getJSON("ages.json", function(data) {
        console.log(data);
        window.data = data;
        
        $.getJSON("sa2.geojson", function(geojson) {
          var geojsonLayer = new L.GeoJSON(geojson, {
            style: function(feature) {
                var id = feature.properties.SA22018_V1_00;
                var saData = data[id].Total;
                var count = saData["65-69 years"] + saData["70-74 years"] + saData["75-79 years"] + saData["80-84 years"] + saData["85 years and over"];
                saData.over65 = count;
                if (colour_mode == "pct") {
                  count = count / saData.Total * 100;
                }
                var color = cmap(count)
                return {
                  fillColor: color,
                  fillOpacity: .7,
                  weight: .5,
                  color: "black",
                };
            },
            filter: function(feature, layer) {
              var id = feature.properties.SA22018_V1_00;
              var saData = data[id].Total;
              return saData.Total > 40;
            },
            onEachFeature: function (feature, layer) {
              var id = feature.properties.SA22018_V1_00;
              var saData = data[id];
              var name = feature.properties.SA22018_V1_NAME;
              saData.name = name;
              var popup = '<div id="graph"></div>';
              layer.bindTooltip(name).bindPopup(popup, {data: saData, minWidth: 800, autoPanPadding: [400, 400]}).on("popupopen", popupHandler);
              layer.on("mouseover", function(e) {
                layer.setStyle({color: "orange"});
                layer.bringToFront();
              }).on("mouseout", function(e) {
                layer.setStyle({color: "black"});
              });
            }
          }).addTo(ageLayer);
          $.getJSON("sa2_centroids_to_DHB.geojson", function(sa2_centroids_to_DHB) {
            console.log(sa2_centroids_to_DHB);
            $.getJSON("NZ_DHB2012.geojson", function(NZ_DHB2012) {
              console.log(NZ_DHB2012);
              new L.GeoJSON(NZ_DHB2012, {
                onEachFeature: function (feature, layer) {
                  layer.bindTooltip(feature.properties.NAME + " DHB")
                },
                style: function(feature) {
                  var name = feature.properties.NAME;
                  var count = 0;
                  var total = 0;
                  for (var i in sa2_centroids_to_DHB.features) {
                    var f = sa2_centroids_to_DHB.features[i];
                    if (f.properties["DHB.NAME"] == name) {
                      var id = f.properties.SA22018_V1;
                      var sa2data = data[id].Total;
                      if (sa2data.over65 != undefined) {
                        count += sa2data.over65;
                      }
                      total += sa2data.Total;
                    }
                  }
                  console.log(name, count, total);
                  if (colour_mode == "pct") {
                    count = count / total * 100;
                  }
                  var color = cmap(count);

                  return {
                    color: "purple",
                    fillColor: color,
                    fillOpacity: 1,
                    weight: 1
                  }
                }
              }).addTo(DHBLayer);
            });
          });
        });
      });

      $.getJSON("https://services.arcgis.com/XTtANUDT8Va4DLwI/arcgis/rest/services/PublicHospitalsNZ/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson", function(geojson) {
        console.log(geojson);
        for (var i in geojson.features) {
          var feature = geojson.features[i];
          var latlng;
          if (feature.geometry.type === "Polygon" || feature.geometry.type == "MultiPolygon") {
            var center = L.latLngBounds(feature.geometry.coordinates[0]).getCenter();
            latlng = [center.lng, center.lat];
          } else if (feature.geometry.type == "Point") {
            latlng = L.GeoJSON.coordsToLatLng(feature.geometry.coordinates);
          } else if (feature.geometry.type == "LineString") {
            var center = L.latLngBounds(feature.geometry.coordinates).getCenter();
            latlng = [center.lng, center.lat];
          } else {
            console.error("Don't know how to handle", feature);
            return;
          }
          var icon = L.icon({
            iconUrl: 'https://wiki.openstreetmap.org/w/images/3/33/Hospital-14.svg',
            iconSize: [28, 28]
          });
          var h = feature.properties;
          var desc = "<b>" + h.Premises_Name + "</b><br>" + h.Service_Types + "<br>" + h.Total_Beds + " total beds<br>" + h.DHB_Name;
          var marker = L.marker(latlng, {icon: icon}).bindTooltip(desc).addTo(hospitalLayer);
        }
      });

      var legend = L.control({position: 'bottomright'});

      legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend');
          if (colour_mode == "pct") {
            div.innerHTML += "<h4>Percentage of population over 65 years old</h4>";
          } else if (colour_mode == "raw_counts") {
            div.innerHTML += "<h4>Number of people over 65 years old</h4>";
          }
          for (var i = 0; i <= MAX_DOMAIN; i += MAX_DOMAIN / 10) {
            div.innerHTML += '<i style="background:' + cmap(i) + '"></i> ' + i + '<br>';
          }
          div.innerHTML += '<div class="legend-source">Source: <a href="https://www.stats.govt.nz/tools/2018-census-place-summaries/" target="_blank">Statistics NZ</a></div>'

          return div;
      };

      legend.addTo(map);
    </script>
  </body>
</html>
