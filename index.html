<html>
  <head>
    <title>2018 Census age data in NZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js" integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js" integrity="sha256-rVeyUZMfAHhQJ7hvWaHrKknTDdqGcn1gxBBJA++E4z8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-overpass-layer@2.8.3/src/OverPassLayer.css" />
    <script src="https://unpkg.com/leaflet-overpass-layer@2.8.3/dist/OverPassLayer.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <h1 id="title">2018 Census age data in NZ</h1>
    <div id="map"></div>
    <script>
      var map = L.map('map').setView([-41.235726,172.5118422], 6);
      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
	      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
	      subdomains: 'abcd',
	      maxZoom: 19,
	      minZoom: 6,
      }).addTo(map);
      var bounds = map.getBounds();
      bounds._northEast.lat += 10;
      bounds._northEast.lng += 10;
      bounds._southWest.lat -= 10;
      bounds._southWest.lng -= 10;
      map.setMaxBounds(bounds);
      
      function round(x, dp) {
        var factor = Math.pow(10, dp);
        var tmp = x * factor;
        tmp = Math.round(tmp);
        return tmp / factor;
      }
      
      function handleNull(string) {
        if (!string) {
          return "No data";
        }
        return string;
      }

      function getPct(ageBracket, yearData) {
        if (!yearData["Total"]) {
          return "No data";
        }
        return round(yearData[ageBracket] / yearData["Total"] * 100, 1) + "%";
      }

      function formatData(name, data) {
        var header = "<h2>" + name + "</h2>"
        if (!data[2018]["Total"]) {
          return header + "No data";
        }
        tableHeader = "<th>Age Bracket</th>";
        tableContent = "<td>Percentage in 2018</td>";
        var keys = ["0-4 years", "5-9 years", "10-14 years", "15-19 years", "20-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years", "60-64 years", "65-69 years", "70-74 years", "75-79 years", "80-84 years", "85 years and over"]
        for (var i in keys) {
          var ageBracket = keys[i];
          if (ageBracket.includes("Total")) continue;
          tableHeader += "<th>" + ageBracket + "</th>";
          tableContent += "<td>" + getPct(ageBracket, data[2018]) + "</td>";
        }
        table = "<table><thead>" + tableHeader + "</thead><tbody>" + tableContent + "</tbody></table>";
        return header + table;
      }

      var cmap = chroma.scale([chroma.hsv(270,1,1), chroma.hsv(180,1,1), chroma.hsv(90,1,1), chroma.hsv(0,1,1)]).mode("hsv").domain([0, 20]);
      
      $.getJSON("ages.json", function(data) {
        console.log(data);
        window.data = data;
        function onEachFeature(feature, layer) {
            var id = feature.properties.SA22018_V1_00;
            var name = feature.properties.SA22018_V1_NAME
            layer.bindPopup(formatData(name, data[id]), {maxWidth: 1000 });
        }
        
        $.getJSON("sa2.geojson", function(geojson) {
          var geojsonLayer = new L.GeoJSON(geojson, {
            style: function(feature) {
                var id = feature.properties.SA22018_V1_00;
                var saData = data[id][2018];
                var count = saData["65-69 years"] + saData["70-74 years"] + saData["75-79 years"] + saData["80-84 years"] + saData["85 years and over"];
                count = count / saData.Total * 100;
                console.log(count);
                var color = cmap(count)
                return {
                  fillColor: color,
                  fillOpacity: .7,
                  weight: 1,
                  color: "black",
                };
            },
            filter: function(feature, layer) {
              var id = feature.properties.SA22018_V1_00;
              var saData = data[id][2018];
              return saData.Total > 40;
            },
            onEachFeature: onEachFeature
          }).addTo(map);
        });
      });

      var legend = L.control({position: 'topleft'});

      legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend');
          div.innerHTML += "<h4>Percentage of population over 65 years old</h4>";
          for (var i = 0; i <= 20; i += 2) {
            div.innerHTML += '<i style="background:' + cmap(i) + '"></i> ' + i + '<br>';
          }
          div.innerHTML += '<div class="legend-source">Source: <a href="https://www.stats.govt.nz/tools/2018-census-place-summaries/" target="_blank">Statistics NZ</a></div>'

          return div;
      };

      legend.addTo(map);
    </script>
  </body>
</html>
